<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Drive Uploader & File Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        /* Global Reset and Base */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f7f9fc;
            color: #333;
            line-height: 1.6;
        }

        /* Header & Navigation */
        header {
            background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
            color: white;
            padding: 30px 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        /* Main Layout */
        main {
            max-width: 1300px; /* TÄƒng chiá»u rá»™ng tá»•ng thá»ƒ */
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* ===== Bá» Cá»¤C 3 Cá»˜T TRÃŠN (Upload + ThÆ° má»¥c ÄÃ­ch + ÄÄƒng nháº­p) ===== */
        .top-column-layout { 
            display: flex;
            gap: 20px; 
            margin-bottom: 25px;
            align-items: stretch;
        }
        
        /* Cá»™t 1 (Upload/Chá»n File): Chiáº¿m 2 pháº§n (1/2) */
        #card_select_upload {
            flex: 2; 
            min-width: 400px;
        }
        
        /* Cá»™t 2 (ThÆ° má»¥c ÄÃ­ch): Chiáº¿m 1 pháº§n (1/4) */
        #card_target_folder {
            flex: 1; 
            min-width: 250px;
        }

        /* Cá»™t 3 (ÄÄƒng nháº­p): Chiáº¿m 1 pháº§n (1/4) */
        #card_login {
            flex: 1; 
            min-width: 200px;
        }
        /* ================================================================= */

        /* Card (Container) Style */
        .card {
            background: #ffffff;
            border-radius: 16px; 
            padding: 25px 30px;
            margin-bottom: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08), 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid #eef1f4;
            transition: transform 0.2s;
            display: flex; 
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
        }

        .card h2 {
            margin: 0 0 5px;
            font-size: 20px;
            color: #1e3a8a;
            border-bottom: 1px solid #f0f4f8; 
            padding-bottom: 8px;
        }

        .card small {
            display: block;
            margin-top: 5px;
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 10px;
        }

        /* Button Styles */
        .buttons-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
        }

        .btn {
            border: none;
            border-radius: 8px; 
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: #2563eb;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        .btn-outline {
            background: #ffffff;
            color: #111827;
            border: 1px solid #d1d5db;
        }
        
        /* File Input Layout cho Cá»™t Upload/Chá»n File */
        #card_select_upload .file-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        /* Table Styles cho Danh sÃ¡ch ThÆ° má»¥c Ä‘Ã­ch */
        #target_folder_list {
            max-height: 400px; /* Giá»›i háº¡n chiá»u cao */
            overflow-y: auto; /* ThÃªm thanh cuá»™n */
            margin-top: 10px;
            padding: 5px;
            border: 1px solid #eef1f4;
            border-radius: 8px;
        }
        
        .folder-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.15s;
            margin-bottom: 2px;
            font-size: 14px;
        }
        
        .folder-item:hover {
            background: #f0f4f8;
        }
        
        .folder-item.selected {
            background: #dbeafe;
            color: #1e3a8a;
            font-weight: 600;
        }

        /* CÃ¡c CSS khÃ¡c Ä‘Æ°á»£c giá»¯ nguyÃªn */

        /* Responsive Adjustments */
        @media (max-width: 1200px) { /* Xáº¿p chá»“ng 3 cá»™t thÃ nh 2 hÃ ng khi mÃ n hÃ¬nh háº¹p */
            .top-column-layout { 
                flex-wrap: wrap;
            }
            #card_select_upload {
                flex: 1 1 100%; /* Upload chiáº¿m háº¿t hÃ ng trÃªn */
                min-width: auto;
            }
            #card_target_folder, #card_login {
                flex: 1 1 45%; /* ThÆ° má»¥c Ä‘Ã­ch vÃ  ÄÄƒng nháº­p chia Ä‘Ã´i hÃ ng dÆ°á»›i */
                min-width: auto;
            }
            #target_folder_list {
                max-height: 300px; /* Giáº£m chiá»u cao trÃªn tablet */
            }
        }
        
        @media (max-width: 768px) { /* Xáº¿p chá»“ng táº¥t cáº£ trÃªn mobile */
            .top-column-layout { 
                display: block;
            }
            .top-column-layout > .card {
                margin-bottom: 25px; 
                flex: unset; 
            }
            
            #card_select_upload .file-section {
                flex-direction: column;
                align-items: stretch;
            }
            #card_select_upload .file-section .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Google Drive File Manager</h1>
        <p>Giao diá»‡n duyá»‡t, upload file vÃ  thÆ° má»¥c Ä‘Æ¡n giáº£n</p>
    </header>

    <main>
        <div class="top-column-layout">
        
            <section id="card_select_upload" class="card">
                <h2><span role="img" aria-label="mÅ©i tÃªn lÃªn">â¬†ï¸</span> Chá»n & Upload File/ThÆ° má»¥c</h2>
                <small>Chá»n tá»‡p/thÆ° má»¥c, sau Ä‘Ã³ báº¥m nÃºt "Báº¯t Ä‘áº§u Upload" Ä‘á»ƒ táº£i lÃªn Drive.</small>

                <div class="file-section">
                    <label for="file_input_files" class="btn btn-outline">
                        ğŸ“„ Chá»n File (nhiá»u file)
                    </label>
                    <input type="file" id="file_input_files" multiple style="display: none;">

                    <label for="file_input_folder" class="btn btn-outline">
                        ğŸ“ Chá»n ThÆ° má»¥c
                    </label>
                    <input type="file" id="file_input_folder" webkitdirectory style="display: none;">
                </div>

                <div id="upload_button_container" class="buttons-row">
                    <button id="upload_button" class="btn btn-primary" disabled>
                        ğŸš€ Báº¯t Ä‘áº§u Upload lÃªn Drive
                    </button>
                </div>

                <div id="upload_status" class="status">
                    ChÆ°a cÃ³ tá»‡p nÃ o Ä‘Æ°á»£c chá»n.
                </div>
                
                <div id="progress_display" class="status" style="display: none; margin-top: 10px; padding: 0;">
                    <div id="progress_text" style="padding: 8px 12px; font-weight: 600;"></div>
                    <div class="progress-bar">
                        <div id="progress_bar_inner" class="progress-bar-inner" style="width: 0%;"></div>
                    </div>
                </div>
            </section>

            <section id="card_target_folder" class="card">
                <h2><span role="img" aria-label="á»• Ä‘Ä©a">ğŸ“</span> Chá»n ThÆ° má»¥c ÄÃ­ch</h2>
                <small>Chá»n thÆ° má»¥c sáº½ lÆ°u trá»¯ cÃ¡c tá»‡p/thÆ° má»¥c báº¡n upload. Máº·c Ä‘á»‹nh: **Drive cá»§a tÃ´i**.</small>
                
                <div id="target_status" class="status" style="margin-top: 5px;">
                    ThÆ° má»¥c hiá»‡n táº¡i: <strong>/Drive cá»§a tÃ´i</strong>
                </div>

                <div id="target_folder_list">
                    <div style="text-align: center; color: #9ca3af;">Äang chá» Ä‘Äƒng nháº­p...</div>
                </div>
                <div class="buttons-row" style="margin-top: 10px;">
                     <button id="reload_target_folders" class="btn btn-outline" disabled>
                        ğŸ”„ Táº£i láº¡i
                    </button>
                </div>

            </section>

            <section id="card_login" class="card">
                <h2><span role="img" aria-label="khÃ³a">ğŸ”‘</span> ÄÄƒng nháº­p Google</h2>
                <small>XÃ¡c thá»±c báº±ng OAuth 2.0 Ä‘á»ƒ cáº¥p quyá»n truy cáº­p Drive.</small>

                <div class="buttons-row">
                    <button id="authorize_button" class="btn btn-primary" disabled>
                        ğŸ” ÄÄƒng nháº­p Google
                    </button>
                    <button id="signout_button" class="btn btn-outline" disabled>
                        ğŸšª ÄÄƒng xuáº¥t
                    </button>
                </div>

                <div id="auth_status" class="status">
                    Tráº¡ng thÃ¡i: <strong>ChÆ°a sáºµn sÃ ng</strong> (Ä‘ang táº£i thÆ° viá»‡n Google...)
                </div>
            </section>
        </div>
        <hr>

        <section id="card_file_list" class="card">
            <h2><span role="img" aria-label="á»• Ä‘Ä©a">ğŸ”</span> Duyá»‡t Google Drive (Danh sÃ¡ch Ä‘áº§y Ä‘á»§)</h2>
            <small>Báº¥m vÃ o tÃªn thÆ° má»¥c Ä‘á»ƒ duyá»‡t file bÃªn trong. KÃ­ch thÆ°á»›c hiá»ƒn thá»‹ tá»‘i Ä‘a 50 má»¥c gáº§n nháº¥t.</small>

            <div class="buttons-row">
                <button id="go_back_button" class="btn btn-outline" disabled style="display: none;">
                    â¬…ï¸ Quay láº¡i ThÆ° má»¥c Cha
                </button>
                <button id="list_button" class="btn btn-outline" disabled>
                    ğŸ”„ Táº£i láº¡i danh sÃ¡ch
                </button>
            </div>
            
            <div id="breadcrumb_path" class="status" style="margin-top: 15px;">
                ÄÆ°á»ng dáº«n hiá»‡n táº¡i: <strong>/Drive cá»§a tÃ´i</strong>
            </div>

            <div id="list_status" class="status">
                ChÆ°a táº£i danh sÃ¡ch file.
            </div>

            </section>

        <footer>
            á»¨ng dá»¥ng Demo Â· HÃ£y nhá»› thay <strong>CLIENT_ID</strong> vÃ  <strong>API_KEY</strong>!
        </footer>
    </main>

    <script>
        // TODO: THAY Báº°NG THÃ”NG TIN THáº¬T Cá»¦A Báº N ---------------
        // TÃ´i giá»¯ CLIENT_ID vÃ  API_KEY cá»§a báº¡n Ä‘á»ƒ cháº¡y thá»­, báº¡n hÃ£y thay tháº¿ báº±ng key thá»±c
        const CLIENT_ID = "957298442128-v4c9rc83fud515f2is92p97lojjoiuja.apps.googleusercontent.com"; 
        const API_KEY = "AIzaSyCxJzJVa5OUlnPDKvyxiUqkIJGQ8-hxZtU"; 
        
        const SCOPES = "https://www.googleapis.com/auth/drive"; 
        const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
        // -------------------------------------------------------

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        const folderIdCache = {}; 
        let filesToUpload = []; 
        
        // BIáº¾N Má»šI: ThÆ° má»¥c Ä‘Ã­ch cho upload (Máº·c Ä‘á»‹nh lÃ  'root')
        let targetFolderId = 'root';
        let targetFolderName = 'Drive cá»§a tÃ´i';

        // Biáº¿n cÅ© cho pháº§n duyá»‡t file toÃ n mÃ n hÃ¬nh
        let currentFolderId = 'root'; 
        let folderHistory = [{ id: 'root', name: 'Drive cá»§a tÃ´i' }];

        // Elements cho ÄÄƒng nháº­p
        const authorizeButton = document.getElementById("authorize_button");
        const signoutButton = document.getElementById("signout_button");
        const authStatus = document.getElementById("auth_status");

        // Elements cho Upload/Chá»n File
        const uploadButton = document.getElementById("upload_button");
        const uploadStatus = document.getElementById("upload_status"); 
        const progressDisplay = document.getElementById("progress_display");
        const progressText = document.getElementById("progress_text");
        const progressBarInner = document.getElementById("progress_bar_inner");
        const fileInputFiles = document.getElementById("file_input_files");
        const fileInputFolder = document.getElementById("file_input_folder");
        
        // Elements Má»šI cho ThÆ° má»¥c ÄÃ­ch
        const targetStatus = document.getElementById("target_status");
        const targetFolderList = document.getElementById("target_folder_list");
        const reloadTargetFoldersButton = document.getElementById("reload_target_folders");

        // Elements cho Duyá»‡t File
        const listButton = document.getElementById("list_button");
        const listStatus = document.getElementById("list_status");
        const filesTbody = document.getElementById("files_tbody");
        const goBackButton = document.getElementById("go_back_button");
        const breadcrumbPath = document.getElementById("breadcrumb_path");
        
        // =========================================================
        // === KHá»I Táº O VÃ€ XÃC THá»°C ===
        // =========================================================

        function gapiLoaded() { gapi.load("client", initializeGapiClient); }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                authStatus.textContent = "ThÆ° viá»‡n Google API Ä‘Ã£ sáºµn sÃ ng. Äang chá» Google Identity Services...";
                maybeEnableAuthButton();
            } catch (error) {
                console.error(error);
                authStatus.textContent = "Lá»—i khá»Ÿi táº¡o Google API: " + error.message;
                authStatus.classList.add("error");
            }
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: "", 
            });
            gisInited = true;
            
            fileInputFiles.onchange = (e) => { filesToUpload = Array.from(e.target.files); updateUploadInputStatus(); };
            fileInputFolder.onchange = (e) => { filesToUpload = Array.from(e.target.files); updateUploadInputStatus(); };
            reloadTargetFoldersButton.onclick = () => { listTargetFolders(); };
            
            maybeEnableAuthButton();
        }

        function maybeEnableAuthButton() {
            if (gapiInited && gisInited) {
                authorizeButton.disabled = false;
                authStatus.textContent = "Sáºµn sÃ ng. Báº¥m \"ÄÄƒng nháº­p Google\" Ä‘á»ƒ cáº¥p quyá»n.";
            }
        }

        // Khi báº¥m ÄÄƒng nháº­p
        authorizeButton.onclick = () => {
            authorizeButton.disabled = true;
            authStatus.textContent = "Äang má»Ÿ popup Ä‘Äƒng nháº­p...";

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error(resp);
                    authStatus.textContent = "Lá»—i Ä‘Äƒng nháº­p: " + (resp.error || "Unknown error");
                    authStatus.classList.add("error");
                    authorizeButton.disabled = false;
                    return;
                }
                
                authStatus.textContent = "ÄÃ£ Ä‘Äƒng nháº­p vÃ  cáº¥p quyá»n cho Google Drive.";
                authStatus.classList.remove("error");
                authStatus.classList.add("success");

                authorizeButton.textContent = "âœ… ÄÃ£ Ä‘Äƒng nháº­p";
                signoutButton.disabled = false;
                listButton.disabled = false;
                updateUploadInputStatus(); 
                
                // === THAY Äá»”I: Tá»° Äá»˜NG Gá»ŒI Cáº¢ 2 HÃ€M SAU KHI ÄÄ‚NG NHáº¬P ===
                await listFiles(); // Táº£i danh sÃ¡ch file Ä‘áº§y Ä‘á»§ á»Ÿ dÆ°á»›i
                await listTargetFolders(); // Táº£i danh sÃ¡ch folder Ä‘Ã­ch á»Ÿ cá»™t 2
            };

            const token = gapi.client.getToken();
            if (!token) {
                tokenClient.requestAccessToken({ prompt: "select_account" });
            } else {
                tokenClient.requestAccessToken({ prompt: "" });
            }
        };

        // ÄÄƒng xuáº¥t (Logic giá»¯ nguyÃªn)
        signoutButton.onclick = () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken("");
            }

            authorizeButton.textContent = "ğŸ” ÄÄƒng nháº­p Google";
            authorizeButton.disabled = false;
            signoutButton.disabled = true;
            uploadButton.disabled = true;
            listButton.disabled = true;
            filesToUpload = []; 
            
            // Reset cÃ¡c tráº¡ng thÃ¡i
            progressDisplay.style.display = 'none';
            filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ xem danh sÃ¡ch file.</td></tr>';
            listStatus.textContent = "ChÆ°a táº£i danh sÃ¡ch file.";
            
            // Reset Ä‘iá»u hÆ°á»›ng vÃ  thÆ° má»¥c Ä‘Ã­ch
            currentFolderId = 'root';
            folderHistory = [{ id: 'root', name: 'Drive cá»§a tÃ´i' }];
            renderBreadcrumb();
            
            targetFolderId = 'root';
            targetFolderName = 'Drive cá»§a tÃ´i';
            targetStatus.innerHTML = 'ThÆ° má»¥c hiá»‡n táº¡i: <strong>/Drive cá»§a tÃ´i</strong>';
            targetFolderList.innerHTML = '<div style="text-align: center; color: #9ca3af;">Äang chá» Ä‘Äƒng nháº­p...</div>';

            authStatus.textContent = "ÄÃ£ Ä‘Äƒng xuáº¥t. Cáº§n Ä‘Äƒng nháº­p láº¡i Ä‘á»ƒ sá»­ dá»¥ng.";
            authStatus.classList.remove("success");
        };

        // =========================================================
        // === HÃ€M Xá»¬ LÃ UPLOAD (ÄÃƒ Cáº¬P NHáº¬T) ===
        // =========================================================
        
        // HÃ m upload file (ÄÃ£ cáº­p nháº­t Ä‘á»ƒ dÃ¹ng targetFolderId)
        uploadButton.onclick = async () => {
            // ... (Logic kiá»ƒm tra Ä‘Äƒng nháº­p vÃ  file giá»¯ nguyÃªn)
            // ... 
            uploadStatus.classList.remove("error", "success");
            const token = gapi.client.getToken();
            if (!token) {
                uploadStatus.textContent = "Báº¡n cáº§n Ä‘Äƒng nháº­p Google trÆ°á»›c.";
                uploadStatus.classList.add("error");
                return;
            }

            const files = filesToUpload; 
            if (files.length === 0) {
                uploadStatus.textContent = "Vui lÃ²ng chá»n file hoáº·c thÆ° má»¥c Ä‘á»ƒ upload.";
                uploadStatus.classList.add("error");
                return;
            }

            uploadButton.disabled = true;
            listButton.disabled = true;
            reloadTargetFoldersButton.disabled = true;
            progressDisplay.style.display = 'block';
            
            let successCount = 0;
            let errorCount = 0;
            
            uploadStatus.textContent = `Äang chuáº©n bá»‹ upload ${files.length} má»¥c vÃ o thÆ° má»¥c: ${targetFolderName}...`;

            try {
                Object.keys(folderIdCache).forEach(k => delete folderIdCache[k]); 

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const totalSize = file.size;
                    const formattedTotalSize = formatBytes(totalSize);

                    progressText.textContent = `Äang upload ${i + 1}/${files.length}: ${file.name}... (0 B / ${formattedTotalSize})`;
                    progressBarInner.style.width = '0%';

                    // 1. Xá»­ lÃ½ Ä‘Æ°á»ng dáº«n thÆ° má»¥c cha
                    let parentFolderId = targetFolderId; // Báº®T Äáº¦U Vá»šI THÆ¯ Má»¤C ÄÃCH ÄÃƒ CHá»ŒN
                    
                    if (file.webkitRelativePath) {
                        const parts = file.webkitRelativePath.split('/');
                        const pathSegments = parts.slice(0, -1); 
                        
                        // Náº¿u lÃ  upload folder, cáº§n táº¡o cáº¥u trÃºc bÃªn trong thÆ° má»¥c Ä‘Ã­ch
                        if (pathSegments.length > 0) {
                            parentFolderId = await createFolderIfNeeded(pathSegments, targetFolderId);
                        }
                    }

                    // 2. Upload file
                    const metadata = {
                        name: file.name,
                        mimeType: file.type || "application/octet-stream",
                        parents: [parentFolderId], 
                    };
                    
                    const form = new FormData();
                    form.append(
                        "metadata",
                        new Blob([JSON.stringify(metadata)], { type: "application/json" })
                    );
                    form.append("file", file);

                    const xhr = new XMLHttpRequest();
                    
                    // HÃ m cáº­p nháº­t tiáº¿n trÃ¬nh
                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const uploaded = event.loaded;
                            const percent = Math.round((uploaded / totalSize) * 100);
                            progressText.textContent = `Äang upload ${i + 1}/${files.length}: ${file.name}... (${formatBytes(uploaded)} / ${formattedTotalSize})`;
                            progressBarInner.style.width = `${percent}%`;
                        }
                    };

                    xhr.open(
                        "POST",
                        "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,iconLink,size,mimeType"
                    );

                    xhr.setRequestHeader("Authorization", "Bearer " + token.access_token);

                    await new Promise((resolve, reject) => {
                        xhr.onload = () => {
                            if (xhr.status >= 200 && xhr.status < 300) {
                                successCount++;
                                resolve();
                            } else {
                                errorCount++;
                                console.error("Lá»—i upload file:", file.name, xhr.responseText);
                                reject(new Error(`Lá»—i upload: ${xhr.status}`));
                            }
                        };
                        xhr.onerror = () => {
                            errorCount++;
                            console.error("Lá»—i máº¡ng khi upload:", file.name);
                            reject(new Error("Lá»—i máº¡ng/káº¿t ná»‘i"));
                        };
                        xhr.send(form);
                    });
                }
                
                // Cáº­p nháº­t tráº¡ng thÃ¡i cuá»‘i cÃ¹ng
                const totalUploaded = successCount + errorCount;
                progressDisplay.style.display = 'none';
                if (errorCount === 0) {
                    uploadStatus.textContent = `âœ… Upload thÃ nh cÃ´ng ${successCount}/${totalUploaded} má»¥c vÃ o thÆ° má»¥c ${targetFolderName}!`;
                    uploadStatus.classList.add("success");
                    uploadStatus.classList.remove("error");
                } else {
                    uploadStatus.textContent = `âš ï¸ HoÃ n táº¥t: Upload thÃ nh cÃ´ng ${successCount}/${totalUploaded} má»¥c, tháº¥t báº¡i ${errorCount} má»¥c.`;
                    uploadStatus.classList.add("error");
                    uploadStatus.classList.remove("success");
                }

                filesToUpload = []; 
                updateUploadInputStatus(); 
                
                // Táº£i láº¡i danh sÃ¡ch file Ä‘áº§y Ä‘á»§ á»Ÿ dÆ°á»›i (náº¿u thÆ° má»¥c Ä‘Ã­ch khá»›p vá»›i thÆ° má»¥c Ä‘ang duyá»‡t)
                if (targetFolderId === currentFolderId) {
                    await listFiles(currentFolderId);
                }
                
            } catch (error) {
                console.error(error);
                progressDisplay.style.display = 'none';
                uploadStatus.textContent = "Lá»—i upload tá»•ng quÃ¡t: " + error.message;
                uploadStatus.classList.add("error");
                uploadStatus.classList.remove("success");
            } finally {
                uploadButton.disabled = false;
                listButton.disabled = false;
                reloadTargetFoldersButton.disabled = false;
            }
        };

        // HÃ m kiá»ƒm tra vÃ  táº¡o Folder trÃªn Drive náº¿u cáº§n (Giá»¯ nguyÃªn)
        async function createFolderIfNeeded(pathSegments, parentId) { /* ... Giá»¯ nguyÃªn logic cÅ© ... */
            let currentParentId = parentId;
            let currentPath = '';

            for (const segment of pathSegments) {
                currentPath = (currentPath ? currentPath + '/' : '') + segment;

                if (folderIdCache[currentPath]) {
                    currentParentId = folderIdCache[currentPath];
                    continue;
                }

                const query = `name = '${segment.replace(/'/g, "\\'")}' and mimeType = 'application/vnd.google-apps.folder' and '${currentParentId}' in parents and trashed = false`;
                const searchRes = await gapi.client.drive.files.list({
                    q: query,
                    fields: 'files(id)',
                    pageSize: 1,
                });

                if (searchRes.result.files.length > 0) {
                    currentParentId = searchRes.result.files[0].id;
                } else {
                    const folderMetadata = {
                        'name': segment,
                        'mimeType': 'application/vnd.google-apps.folder',
                        'parents': [currentParentId],
                    };

                    const createRes = await gapi.client.drive.files.create({
                        resource: folderMetadata,
                        fields: 'id',
                    });
                    currentParentId = createRes.result.id;
                }

                folderIdCache[currentPath] = currentParentId;
            }
            return currentParentId;
        }

        // =========================================================
        // === HÃ€M LIá»†T KÃŠ THÆ¯ Má»¤C ÄÃCH (Má»šI) ===
        // =========================================================
        
        async function listTargetFolders() {
            targetFolderList.innerHTML = '<div style="text-align: center; color: #2563eb;">Äang táº£i danh sÃ¡ch thÆ° má»¥c...</div>';
            reloadTargetFoldersButton.disabled = true;

            try {
                const response = await gapi.client.drive.files.list({
                    pageSize: 50, // Láº¥y 50 má»¥c gáº§n nháº¥t
                    fields: "files(id,name,mimeType)",
                    orderBy: "name", // Sáº¯p xáº¿p theo tÃªn
                    // Chá»‰ láº¥y thÆ° má»¥c
                    q: `mimeType = 'application/vnd.google-apps.folder' and trashed = false`, 
                });

                const folders = response.result.files || [];
                targetFolderList.innerHTML = "";
                
                // ThÃªm thÆ° má»¥c gá»‘c
                const rootFolder = { id: 'root', name: 'Drive cá»§a tÃ´i' };
                renderFolderItem(rootFolder);

                if (folders.length > 0) {
                    folders.forEach(renderFolderItem);
                } else if (folders.length === 0 && targetFolderId !== 'root') {
                    // Náº¿u khÃ´ng cÃ³ thÆ° má»¥c nÃ o ngoÃ i thÆ° má»¥c gá»‘c
                    targetFolderList.innerHTML = '<div style="text-align: center; color: #4b5563;">Chá»‰ cÃ³ thÆ° má»¥c gá»‘c.</div>';
                }
                
                // Äáº£m báº£o tráº¡ng thÃ¡i hiá»‡n táº¡i Ä‘Æ°á»£c hiá»ƒn thá»‹ Ä‘Ãºng
                const currentTargetFolder = document.querySelector(`.folder-item[data-id="${targetFolderId}"]`);
                if (currentTargetFolder) {
                    currentTargetFolder.classList.add('selected');
                }
                
            } catch (error) {
                console.error("Lá»—i táº£i danh sÃ¡ch thÆ° má»¥c Ä‘Ã­ch:", error);
                targetFolderList.innerHTML = '<div style="text-align: center; color: #dc2626;">Lá»—i táº£i danh sÃ¡ch.</div>';
            } finally {
                reloadTargetFoldersButton.disabled = false;
            }
        }
        
        // HÃ m render tá»«ng má»¥c folder
        function renderFolderItem(folder) {
            const div = document.createElement('div');
            div.className = 'folder-item';
            div.setAttribute('data-id', folder.id);
            div.setAttribute('data-name', folder.name);

            // Kiá»ƒm tra vÃ  set tráº¡ng thÃ¡i selected
            if (folder.id === targetFolderId) {
                div.classList.add('selected');
            }

            div.innerHTML = `ğŸ“ ${folder.name}`;
            
            div.onclick = () => {
                // XÃ³a tráº¡ng thÃ¡i selected cÅ©
                document.querySelectorAll('.folder-item').forEach(item => item.classList.remove('selected'));
                
                // Set tráº¡ng thÃ¡i selected má»›i
                div.classList.add('selected');
                
                // Cáº­p nháº­t biáº¿n thÆ° má»¥c Ä‘Ã­ch
                targetFolderId = folder.id;
                targetFolderName = folder.name;
                
                // Cáº­p nháº­t tráº¡ng thÃ¡i hiá»ƒn thá»‹
                targetStatus.innerHTML = `ThÆ° má»¥c hiá»‡n táº¡i: <strong>/${targetFolderName}</strong>`;

                // Tá»± Ä‘á»™ng cuá»™n Ä‘áº¿n má»¥c Ä‘Ã£ chá»n
                div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            };

            targetFolderList.appendChild(div);
        }


        // =========================================================
        // === HÃ€M LIá»†T KÃŠ FILE VÃ€ ÄIá»€U HÆ¯á»šNG (GIá»® NGUYÃŠN) ===
        // =========================================================
        
        // ... (CÃ¡c hÃ m navigateHistory, renderBreadcrumb, listFiles, formatBytes giá»¯ nguyÃªn logic cÅ©) ...
        
        goBackButton.onclick = () => { navigateHistory(folderHistory.length - 2); };
        listButton.onclick = () => { folderHistory = [{ id: 'root', name: 'Drive cá»§a tÃ´i' }]; listFiles('root'); };

        function navigateHistory(index) {
            if (index < 0 || index >= folderHistory.length - 1) return;
            const targetFolder = folderHistory[index];
            folderHistory = folderHistory.slice(0, index + 1);
            listFiles(targetFolder.id);
        }
        
        function renderBreadcrumb() {
            let path = 'ÄÆ°á»ng dáº«n hiá»‡n táº¡i: ';
            path += folderHistory.map((item, index) => {
                if (index < folderHistory.length - 1) {
                    return `<a href="javascript:void(0)" class="link" onclick="navigateHistory(${index})">${item.name}</a>`;
                }
                return `<strong>${item.name}</strong>`;
            }).join(' / ');
            
            breadcrumbPath.innerHTML = path;
            
            if (folderHistory.length > 1) {
                goBackButton.disabled = false;
                goBackButton.style.display = 'inline-flex';
            } else {
                goBackButton.disabled = true;
                goBackButton.style.display = 'none';
            }
        }

        async function listFiles(folderId = currentFolderId) {
            listStatus.classList.remove("error", "success");
            const token = gapi.client.getToken();
            if (!token) {
                listStatus.textContent = "Báº¡n cáº§n Ä‘Äƒng nháº­p Google trÆ°á»›c.";
                listStatus.classList.add("error");
                return;
            }
                
            currentFolderId = folderId;
            renderBreadcrumb();

            listButton.disabled = true;
            listStatus.textContent = "Äang táº£i danh sÃ¡ch file...";
            filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">Äang táº£i...</td></tr>';

            try {
                const response = await gapi.client.drive.files.list({
                    pageSize: 50, 
                    fields: "files(id,name,mimeType,modifiedTime,iconLink,webViewLink,size)",
                    orderBy: "folder,name",
                    q: `'${currentFolderId}' in parents and trashed = false`, 
                });

                const files = response.result.files || [];
                filesTbody.innerHTML = "";

                if (files.length === 0) {
                    listStatus.textContent = "KhÃ´ng tÃ¬m tháº¥y file/thÆ° má»¥c nÃ o trong thÆ° má»¥c nÃ y.";
                    listStatus.classList.add("success");
                    filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">ThÆ° má»¥c nÃ y trá»‘ng.</td></tr>';
                    return;
                }

                for (const file of files) {
                    const tr = document.createElement("tr");
                    const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                    
                    if (isFolder) {
                        tr.classList.add('folder-row');
                        tr.onclick = () => {
                            folderHistory.push({ id: file.id, name: file.name });
                            listFiles(file.id); 
                        };
                    }

                    const nameTd = document.createElement("td");
                    nameTd.textContent = file.name || "(KhÃ´ng tÃªn)";
                    nameTd.setAttribute('data-label', 'TÃªn file');

                    const typeTd = document.createElement("td");
                    const tag = document.createElement("span");
                    tag.className = "tag";
                    tag.textContent = isFolder ? "ğŸ“ Folder" : (file.mimeType || "Unknown"); 
                    typeTd.appendChild(tag);
                    typeTd.setAttribute('data-label', 'Loáº¡i');

                    const modifiedTd = document.createElement("td");
                    modifiedTd.textContent = file.modifiedTime
                        ? new Date(file.modifiedTime).toLocaleString()
                        : "";
                    modifiedTd.setAttribute('data-label', 'Cáº­p nháº­t');

                    const sizeTd = document.createElement("td");
                    sizeTd.textContent = isFolder 
                        ? "-" 
                        : (file.size ? formatBytes(parseInt(file.size, 10)) : "-");
                    sizeTd.setAttribute('data-label', 'KÃ­ch thÆ°á»›c');

                    const linkTd = document.createElement("td");
                    linkTd.setAttribute('data-label', 'Xem');
                    if (file.webViewLink) {
                        const a = document.createElement("a");
                        a.href = file.webViewLink;
                        a.target = "_blank";
                        a.rel = "noopener noreferrer";
                        a.className = "link";
                        a.textContent = isFolder ? "Má»Ÿ Folder" : "Xem File";
                        if (isFolder) {
                            a.style.opacity = '0.7';
                            a.onclick = (e) => { e.stopPropagation(); }; 
                        }
                        linkTd.appendChild(a);
                    } else {
                        linkTd.textContent = "-";
                    }

                    tr.appendChild(nameTd);
                    tr.appendChild(typeTd);
                    tr.appendChild(modifiedTd);
                    tr.appendChild(sizeTd);
                    tr.appendChild(linkTd);

                    filesTbody.appendChild(tr);
                }

                listStatus.textContent = `ÄÃ£ táº£i ${files.length} má»¥c.`;
                listStatus.classList.add("success");
            } catch (error) {
                console.error(error);
                listStatus.textContent = "Lá»—i táº£i danh sÃ¡ch file: " + error.message;
                listStatus.classList.add("error");
            } finally {
                listButton.disabled = false;
            }
        }
        
        function updateUploadInputStatus() { /* ... Giá»¯ nguyÃªn logic cÅ© ... */
            const count = filesToUpload.length;
            if (count > 0) {
                uploadStatus.textContent = `Sáºµn sÃ ng upload ${count} má»¥c. ThÆ° má»¥c Ä‘Ã­ch: ${targetFolderName}`;
                uploadStatus.classList.remove("error", "success");
                uploadButton.disabled = false;
            } else {
                uploadStatus.textContent = "ChÆ°a cÃ³ tá»‡p nÃ o Ä‘Æ°á»£c chá»n.";
                uploadStatus.classList.remove("error", "success");
                uploadButton.disabled = true;
            }
            progressDisplay.style.display = 'none';
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB", "TB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>