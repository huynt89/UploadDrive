<!DOCTYPE html>
<html lang="vi">
<head>
	 <meta charset="UTF-8">
	 <title>Drive Uploader & File Explorer</title>
	 <meta name="viewport" content="width=device-width, initial-scale=1">

	 	 <style>
	 	 /* Global Reset and Base */
	 	 * {
	 	 	 box-sizing: border-box;
	 	 }

	 	 body {
	 	 	 margin: 0;
	 	 	 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	 	 	 background: #f7f9fc;
	 	 	 color: #333;
	 	 	 line-height: 1.6;
	 	 }

	 	 /* Header & Navigation */
	 	 header {
	 	 	 background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
	 	 	 color: white;
	 	 	 padding: 30px 24px;
	 	 	 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
	 	 	 text-align: center;
	 	 }

	 	 header h1 {
	 	 	 margin: 0;
	 	 	 font-size: 28px;
	 	 	 font-weight: 700;
	 	 }

	 	 header p {
	 	 	 margin: 8px 0 0;
	 	 	 font-size: 14px;
	 	 	 opacity: 0.9;
	 	 }

	 	 /* Main Layout */
	 	 main {
	 	 	 max-width: 1200px; 
	 	 	 margin: 30px auto;
	 	 	 padding: 0 20px;
	 	 }
	 	 
	 	 /* ===== Bá» Cá»¤C 2 Cá»˜T (2/3 + 1/3) ===== */
	 	 .three-column-layout { 
	 	 	 display: flex;
	 	 	 gap: 20px; 
	 	 	 margin-bottom: 25px;
	 	 	 align-items: stretch;
	 	 }
	 	 
	 	 /* Cá»™t 1 & 2 (Upload/Chá»n File): Chiáº¿m 2 pháº§n */
	 	 #card_select_upload {
	 	 	flex: 2; 
	 	 	margin-bottom: 0;
	 	 }
	 	 
	 	 /* Cá»™t 3 (ÄÄƒng nháº­p): Chiáº¿m 1 pháº§n */
	 	 #card_login {
	 	 	flex: 1; 
	 	 	margin-bottom: 0;
	 	 }
	 	 /* ======================================= */

	 	 /* Card (Container) Style */
	 	 .card {
	 	 	 background: #ffffff;
	 	 	 border-radius: 16px; 
	 	 	 padding: 25px 30px;
	 	 	 margin-bottom: 25px;
	 	 	 box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08), 0 2px 5px rgba(0, 0, 0, 0.05);
	 	 	 border: 1px solid #eef1f4;
	 	 	 transition: transform 0.2s;
	 	 	 display: flex; 
	 	 	 flex-direction: column;
	 	 }
	 	 
	 	 .card:hover {
	 	 	 transform: translateY(-3px);
	 	 	 box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
	 	 }

	 	 .card h2 {
	 	 	 margin: 0 0 5px;
	 	 	 font-size: 20px;
	 	 	 color: #1e3a8a;
	 	 	 border-bottom: 1px solid #f0f4f8; 
	 	 	 padding-bottom: 8px;
	 	 }

	 	 .card small {
	 	 	 display: block;
	 	 	 margin-top: 5px;
	 	 	 color: #6b7280;
	 	 	 font-size: 13px;
	 	 	 margin-bottom: 10px;
	 	 }

	 	 /* Button Styles */
	 	 .buttons-row {
	 	 	 display: flex;
	 	 	 flex-wrap: wrap;
	 	 	 align-items: center;
	 	 	 gap: 12px;
	 	 	 margin-top: 15px;
	 	 }

	 	 .btn {
	 	 	 border: none;
	 	 	 border-radius: 8px; 
	 	 	 padding: 10px 20px;
	 	 	 font-size: 15px;
	 	 	 font-weight: 600;
	 	 	 cursor: pointer;
	 	 	 display: inline-flex;
	 	 	 align-items: center;
	 	 	 gap: 8px;
	 	 	 transition: all 0.2s ease;
	 	 	 white-space: nowrap;
	 	 }

	 	 .btn-primary {
	 	 	 background: #2563eb;
	 	 	 color: #ffffff;
	 	 	 box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
	 	 }
	 	 
	 	 /* File Input Layout cho Cá»™t Upload/Chá»n File */
	 	 #card_select_upload .file-section {
	 	 	 display: flex;
	 	 	 flex-wrap: wrap;
	 	 	 gap: 10px;
	 	 	 align-items: center;
	 	 }

	 	 /* Tiáº¿n trÃ¬nh vÃ  tráº¡ng thÃ¡i upload */
	 	 #upload_button_container {
	 	 	margin-top: 15px;
	 	 }
	 	 
	 	 #card_select_upload .status {
	 	 	margin-top: 20px;
	 	 }

	 	 /* CÃ¡c pháº§n CSS cÃ²n láº¡i Ä‘Æ°á»£c giá»¯ nguyÃªn */
	 	 
	 	 .btn-primary:hover:not(:disabled) {
	 	 	 background: #1d4ed8;
	 	 	 transform: translateY(-2px);
	 	 	 box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
	 	 }

	 	 .btn-outline {
	 	 	 background: #ffffff;
	 	 	 color: #111827;
	 	 	 border: 1px solid #d1d5db;
	 	 }

	 	 .btn-outline:hover:not(:disabled) {
	 	 	 background: #f3f4f6;
	 	 	 border-color: #9ca3af;
	 	 }

	 	 .btn:disabled {
	 	 	 opacity: 0.6;
	 	 	 cursor: not-allowed;
	 	 	 box-shadow: none;
	 	 	 transform: none;
	 	 }

	 	 /* Status and Feedback */
	 	 .status {
	 	 	 margin-top: 10px;
	 	 	 padding: 8px 12px;
	 	 	 border-radius: 6px;
	 	 	 font-size: 14px;
	 	 	 border: 1px solid transparent;
	 	 }

	 	 .status strong {
	 	 	 font-weight: 700;
	 	 }

	 	 .status.error {
	 	 	 background: #fef2f2;
	 	 	 color: #dc2626;
	 	 	 border-color: #fca5a5;
	 	 }

	 	 .status.success {
	 	 	 background: #f0fdf4;
	 	 	 color: #16a34a;
	 	 	 border-color: #86efac;
	 	 }

	 	 /* Progress Bar */
	 	 .progress-bar {
	 	 	 width: 100%;
	 	 	 height: 10px;
	 	 	 background: #e5e7eb;
	 	 	 border-radius: 5px;
	 	 	 margin-top: 8px;
	 	 	 overflow: hidden;
	 	 }

	 	 .progress-bar-inner {
	 	 	 height: 100%;
	 	 	 background: #22c55e;
	 	 	 transition: width 0.3s ease;
	 	 }

	 	 /* Table Styles */
	 	 table {
	 	 	 width: 100%;
	 	 	 border-collapse: separate; 
	 	 	 border-spacing: 0;
	 	 	 margin-top: 20px;
	 	 	 font-size: 14px;
	 	 	 border-radius: 10px;
	 	 	 overflow: hidden; 
	 	 	 box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
	 	 }

	 	 th, td {
	 	 	 padding: 12px 15px;
	 	 	 text-align: left;
	 	 	 border-bottom: 1px solid #eef1f4;
	 	 }
	 	 
	 	 tr:last-child td {
	 	 	 border-bottom: none;
	 	 }

	 	 th {
	 	 	 background: #f0f4f8;
	 	 	 font-weight: 600;
	 	 	 color: #4b5563;
	 	 	 text-transform: uppercase;
	 	 	 font-size: 12px;
	 	 }
	 	 
	 	 .folder-row {
	 	 	 cursor: pointer;
	 	 	 transition: background 0.15s;
	 	 }

	 	 .folder-row:hover {
	 	 	 background: #eef1f4;
	 	 }
	 	 
	 	 tr:not(.folder-row):hover {
	 	 	 background: #f9fafb;
	 	 }

	 	 /* Tags and Links */
	 	 .tag {
	 	 	 display: inline-flex;
	 	 	 align-items: center;
	 	 	 padding: 4px 10px;
	 	 	 border-radius: 999px;
	 	 	 background: #dbeafe;
	 	 	 color: #1e3a8a;
	 	 	 font-size: 12px;
	 	 	 font-weight: 600;
	 	 }

	 	 .link {
	 	 	 color: #2563eb;
	 	 	 text-decoration: none;
	 	 	 font-weight: 500;
	 	 }

	 	 .link:hover {
	 	 	 text-decoration: underline;
	 	 }
	 	 
	 	 /* Breadcrumb/Path Style */
	 	 #breadcrumb_path {
	 	 	 padding: 10px 15px;
	 	 	 background: #ffffff;
	 	 	 border: 1px solid #eef1f4;
	 	 	 border-radius: 8px;
	 	 	 font-size: 14px;
	 	 	 margin-bottom: 15px;
	 	 }

	 	 /* Footer */
	 	 footer {
	 	 	 text-align: center;
	 	 	 font-size: 13px;
	 	 	 color: #9ca3af;
	 	 	 padding: 20px 0;
	 	 }

	 	 /* Responsive Adjustments */
	 	 @media (max-width: 992px) { /* Giáº£m ngÆ°á»¡ng Ä‘á»ƒ xáº¿p chá»“ng sá»›m hÆ¡n (táº¡i 992px) */
	 	 	.three-column-layout { 
	 	 	 	 	 display: block;
	 	 	 	 	 margin-bottom: 0;
	 	 	 }
	 	 	.three-column-layout > .card {
	 	 	 	 	 margin-bottom: 25px; 
	 	 	 	 	 flex: unset; /* VÃ´ hiá»‡u hÃ³a flex Ä‘á»ƒ xáº¿p chá»“ng */
	 	 	 }
	 	 	
	 	 	/* Äáº£m báº£o cÃ¡c nÃºt Chá»n File xáº¿p chá»“ng trÃªn di Ä‘á»™ng */
	 	 	#card_select_upload .file-section {
	 	 		flex-direction: column;
	 	 		align-items: stretch;
	 	 	}
	 	 	#card_select_upload .file-section .btn {
	 	 		width: 100%;
	 	 		justify-content: center;
	 	 	}
	 	 }
	 	 
	 	 @media (max-width: 768px) {
	 	 	/* Giá»¯ nguyÃªn responsive cho mÃ n hÃ¬nh nhá» hÆ¡n 768px */
	 	 	 header {
	 	 	 	 padding: 20px 15px;
	 	 	 }
	 	 	 
	 	 	 main {
	 	 	 	 margin: 20px auto;
	 	 	 	 padding: 0 10px;
	 	 	 }

	 	 	 .card {
	 	 	 	 padding: 15px;
	 	 	 	 border-radius: 12px;
	 	 	 }

	 	 	 .btn {
	 	 	 	 padding: 8px 15px;
	 	 	 	 font-size: 14px;
	 	 	 }

	 	 	/* Responsive Table */
	 	 	 table, thead, tbody, th, td, tr {
	 	 	 	 display: block;
	 	 	 	 width: 100%;
	 	 	 }
	 	 	 
	 	 	 thead tr {
	 	 	 	 position: absolute;
	 	 	 	 top: -9999px;
	 	 	 	 left: -9999px;
	 	 	 }

	 	 	 tr {
	 	 	 	 border: 1px solid #eef1f4;
	 	 	 	 margin-bottom: 10px;
	 	 	 	 border-radius: 8px;
	 	 	 }
	 	 	 
	 	 	 td {
	 	 	 	 border: none;
	 	 	 	 position: relative;
	 	 	 	 padding-left: 50%;
	 	 	 	 text-align: right;
	 	 	 	 font-size: 14px;
	 	 	 }
	 	 	 
	 	 	 td::before {
	 	 	 	 content: attr(data-label);
	 	 	 	 position: absolute;
	 	 	 	 left: 6px;
	 	 	 	 width: 45%;
	 	 	 	 padding-right: 10px;
	 	 	 	 white-space: nowrap;
	 	 	 	 text-align: left;
	 	 	 	 font-weight: 600;
	 	 	 	 color: #4b5563;
	 	 	 	 font-size: 12px;
	 	 	 }
	 	 	 
	 	 	 .folder-row:hover {
	 	 	 	 background: #eef1f4;
	 	 	 }
	 	 }
	 </style>
</head>
<body>
	 <header>
	 	 <h1>Google Drive File Manager</h1>
	 	 <p>Giao diá»‡n duyá»‡t, upload file vÃ  thÆ° má»¥c Ä‘Æ¡n giáº£n</p>
	 </header>

	 <main>
	 	 	 	 <div class="three-column-layout">
	 	 
	 	 	 	 	 	 <section id="card_select_upload" class="card">
	 	 	 	 <h2><span role="img" aria-label="mÅ©i tÃªn lÃªn">â¬†ï¸</span> Chá»n & Upload File/ThÆ° má»¥c</h2>
	 	 	 	 <small>Chá»n tá»‡p/thÆ° má»¥c, sau Ä‘Ã³ báº¥m nÃºt "Báº¯t Ä‘áº§u Upload" Ä‘á»ƒ táº£i lÃªn Drive.</small>

	 	 	 		 	 	 	 <div class="file-section">
	 	 	 	 	 	 	 	 	 	 <label for="file_input_files" class="btn btn-outline">
	 	 	 	 	 	 ğŸ“„ Chá»n File (nhiá»u file)
	 	 	 	 	 </label>
	 	 	 	 	 <input type="file" id="file_input_files" multiple style="display: none;">

	 	 	 	 	 	 	 	 	 	 <label for="file_input_folder" class="btn btn-outline">
	 	 	 	 	 	 ğŸ“ Chá»n ThÆ° má»¥c
	 	 	 	 	 </label>
	 	 	 	 	 <input type="file" id="file_input_folder" webkitdirectory style="display: none;">
	 	 	 	 </div>

			 	 	 	 <div id="upload_button_container" class="buttons-row">
	 	 	 	 	 <button id="upload_button" class="btn btn-primary" disabled>
	 	 	 	 	 	 ğŸš€ Báº¯t Ä‘áº§u Upload lÃªn Drive
	 	 	 	 	 </button>
	 	 	 	 </div>

			 	 	 	 <div id="upload_status" class="status">
	 	 	 	 	 ChÆ°a cÃ³ tá»‡p nÃ o Ä‘Æ°á»£c chá»n.
	 	 	 	 </div>
	 	 	 	 
	 	 	 	 <div id="progress_display" class="status" style="display: none; margin-top: 10px; padding: 0;">
	 	 	 	 	 <div id="progress_text" style="padding: 8px 12px; font-weight: 600;"></div>
	 	 	 	 	 <div class="progress-bar">
	 	 	 	 	 	 <div id="progress_bar_inner" class="progress-bar-inner" style="width: 0%;"></div>
	 	 	 	 	 </div>
	 	 	 	 </div>
	 	 	 </section>

	 	 	 	 	 	 <section id="card_login" class="card">
	 	 	 	 <h2><span role="img" aria-label="khÃ³a">ğŸ”‘</span> ÄÄƒng nháº­p Google</h2>
	 	 	 	 <small>XÃ¡c thá»±c báº±ng OAuth 2.0 Ä‘á»ƒ cáº¥p quyá»n truy cáº­p Drive.</small>

	 	 	 	 <div class="buttons-row">
	 	 	 	 	 <button id="authorize_button" class="btn btn-primary" disabled>
	 	 	 	 	 	 ğŸ” ÄÄƒng nháº­p Google
	 	 	 	 	 </button>
	 	 	 	 	 <button id="signout_button" class="btn btn-outline" disabled>
	 	 	 	 	 	 ğŸšª ÄÄƒng xuáº¥t
	 	 	 	 	 </button>
	 	 	 	 </div>

	 	 	 	 <div id="auth_status" class="status">
	 	 	 	 	 Tráº¡ng thÃ¡i: <strong>ChÆ°a sáºµn sÃ ng</strong> (Ä‘ang táº£i thÆ° viá»‡n Google...)
	 	 	 	 </div>
	 	 	 </section>
	 	 </div>
	 	 	 	 ---

	 	 	 	 <section id="card_file_list" class="card">
	 	 	 <h2><span role="img" aria-label="á»• Ä‘Ä©a">ğŸ’¾</span> Duyá»‡t Google Drive</h2>
	 	 	 <small>Báº¥m vÃ o tÃªn thÆ° má»¥c Ä‘á»ƒ duyá»‡t file bÃªn trong. KÃ­ch thÆ°á»›c hiá»ƒn thá»‹ tá»‘i Ä‘a 50 má»¥c gáº§n nháº¥t.</small>

	 	 	 <div class="buttons-row">
	 	 	 	 <button id="go_back_button" class="btn btn-outline" disabled style="display: none;">
	 	 	 	 	 â¬…ï¸ Quay láº¡i ThÆ° má»¥c Cha
	 	 	 	 </button>
	 	 	 	 <button id="list_button" class="btn btn-outline" disabled>
	 	 	 	 	 ğŸ”„ Táº£i láº¡i danh sÃ¡ch
	 	 	 	 </button>
	 	 	 </div>
	 	 	 
	 	 	 <div id="breadcrumb_path" class="status" style="margin-top: 15px;">
	 	 	 	 ÄÆ°á»ng dáº«n hiá»‡n táº¡i: <strong>/Drive cá»§a tÃ´i</strong>
	 	 	 </div>

	 	 	 <div id="list_status" class="status">
	 	 	 	 ChÆ°a táº£i danh sÃ¡ch file.
	 	 	 </div>

	 	 	 <table>
	 	 	 	 <thead>
	 	 	 	 	 <tr>
	 	 	 	 	 	 <th>TÃªn file</th>
	 	 	 	 	 	 <th>Loáº¡i</th>
	 	 	 	 	 	 <th>Cáº­p nháº­t</th>
	 	 	 	 	 	 <th>KÃ­ch thÆ°á»›c</th>
	 	 	 	 	 	 <th>Xem</th>
	 	 	 	 	 </tr>
	 	 	 	 </thead>
	 	 	 	 <tbody id="files_tbody">
	 	 	 	 	 <tr><td colspan="5" style="text-align:center; color: #9ca3af;">Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ xem danh sÃ¡ch file.</td></tr>
	 	 	 	 </tbody>
	 	 	 </table>
	 	 </section>

	 	 <footer>
	 	 	 á»¨ng dá»¥ng Demo Â· HÃ£y nhá»› thay <strong>CLIENT_ID</strong> vÃ  <strong>API_KEY</strong>!
	 	 </footer>
	 </main>

	 <script>
		// TODO: THAY Báº°NG THÃ”NG TIN THáº¬T Cá»¦A Báº N ---------------
		const CLIENT_ID = "957298442128-v4c9rc83fud515f2is92p97lojjoiuja.apps.googleusercontent.com"; // OAuth 2.0 Client ID
		const API_KEY = "AIzaSyCxJzJVa5OUlnPDKvyxiUqkIJGQ8-hxZtU"; // API key

		const SCOPES = "https://www.googleapis.com/auth/drive";	
		const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
		// -------------------------------------------------------

		let tokenClient;
		let gapiInited = false;
		let gisInited = false;
		const folderIdCache = {}; 
		let filesToUpload = []; 
		
		let currentFolderId = 'root'; 
		let folderHistory = [{ id: 'root', name: 'Drive cá»§a tÃ´i' }];

		// CÃ¡c element cho ÄÄƒng nháº­p
		const authorizeButton = document.getElementById("authorize_button");
		const signoutButton = document.getElementById("signout_button");
		const authStatus = document.getElementById("auth_status");

		// CÃ¡c element cho Upload/Chá»n File
		const uploadButton = document.getElementById("upload_button");
		const uploadStatus = document.getElementById("upload_status"); 
        
		const progressDisplay = document.getElementById("progress_display");
		const progressText = document.getElementById("progress_text");
		const progressBarInner = document.getElementById("progress_bar_inner");
		
		const fileInputFiles = document.getElementById("file_input_files");
		const fileInputFolder = document.getElementById("file_input_folder");

		// CÃ¡c element cho Duyá»‡t File
		const listButton = document.getElementById("list_button");
		const listStatus = document.getElementById("list_status");
		const filesTbody = document.getElementById("files_tbody");
		
		const goBackButton = document.getElementById("go_back_button");
		const breadcrumbPath = document.getElementById("breadcrumb_path");
		
		// Xá»­ lÃ½ nÃºt Quay láº¡i
		goBackButton.onclick = () => {
			navigateHistory(folderHistory.length - 2);
		};


		// Gá»i khi api.js load xong
		function gapiLoaded() {
			 gapi.load("client", initializeGapiClient);
		}

		// Khá»Ÿi táº¡o client cá»§a Google API
		async function initializeGapiClient() {
			 try {
			await gapi.client.init({
				 apiKey: API_KEY,
				 discoveryDocs: [DISCOVERY_DOC],
			});
			gapiInited = true;
			authStatus.textContent = "ThÆ° viá»‡n Google API Ä‘Ã£ sáºµn sÃ ng. Äang chá» Google Identity Services...";
			maybeEnableAuthButton();
			 } catch (error) {
			console.error(error);
			authStatus.textContent = "Lá»—i khá»Ÿi táº¡o Google API: " + error.message;
			authStatus.classList.add("error");
			 }
		}

		// Gá»i khi gsi/client load xong
		function gisLoaded() {
			 tokenClient = google.accounts.oauth2.initTokenClient({
			client_id: CLIENT_ID,
			scope: SCOPES,
			callback: "", 
			 });
			 gisInited = true;
			
			// Láº¯ng nghe sá»± kiá»‡n chá»n file/folder ngay sau khi GIS load
			fileInputFiles.onchange = (e) => {
				filesToUpload = Array.from(e.target.files);
				updateUploadInputStatus();
			};

			fileInputFolder.onchange = (e) => {
				filesToUpload = Array.from(e.target.files);
				updateUploadInputStatus();
			};
			
			 maybeEnableAuthButton();
		}

		// Chá»‰ enable nÃºt login khi cáº£ 2 thÆ° viá»‡n Ä‘Ã£ sáºµn sÃ ng
		function maybeEnableAuthButton() {
			 if (gapiInited && gisInited) {
			authorizeButton.disabled = false;
			authStatus.textContent = "Sáºµn sÃ ng. Báº¥m \"ÄÄƒng nháº­p Google\" Ä‘á»ƒ cáº¥p quyá»n.";
			 }
		}

		// Cáº­p nháº­t tráº¡ng thÃ¡i sau khi chá»n file/folder
		function updateUploadInputStatus() {
			const count = filesToUpload.length;
			if (count > 0) {
				uploadStatus.textContent = `Sáºµn sÃ ng upload ${count} má»¥c.`;
				uploadStatus.classList.remove("error", "success");
				uploadButton.disabled = false;
			} else {
				uploadStatus.textContent = "ChÆ°a cÃ³ tá»‡p nÃ o Ä‘Æ°á»£c chá»n.";
				uploadStatus.classList.remove("error", "success");
				uploadButton.disabled = true;
			}
			progressDisplay.style.display = 'none';
		}

		// Khi báº¥m ÄÄƒng nháº­p
		authorizeButton.onclick = () => {
			 authorizeButton.disabled = true;
			 authStatus.textContent = "Äang má»Ÿ popup Ä‘Äƒng nháº­p...";

			 tokenClient.callback = async (resp) => {
			if (resp.error !== undefined) {
				 console.error(resp);
				 authStatus.textContent = "Lá»—i Ä‘Äƒng nháº­p: " + (resp.error || "Unknown error");
				 authStatus.classList.add("error");
				 authorizeButton.disabled = false;
				 return;
			}
			
			authStatus.textContent = "ÄÃ£ Ä‘Äƒng nháº­p vÃ  cáº¥p quyá»n cho Google Drive.";
			authStatus.classList.remove("error");
			authStatus.classList.add("success");

			authorizeButton.textContent = "âœ… ÄÃ£ Ä‘Äƒng nháº­p";
			signoutButton.disabled = false;
			listButton.disabled = false;
			updateUploadInputStatus(); 
			
			listFiles(); 
			 };

			 const token = gapi.client.getToken();
			 if (!token) {
			tokenClient.requestAccessToken({ prompt: "select_account" });
			 } else {
			tokenClient.requestAccessToken({ prompt: "" });
			 }
		};

		// ÄÄƒng xuáº¥t
		signoutButton.onclick = () => {
			 const token = gapi.client.getToken();
			 if (token !== null) {
			google.accounts.oauth2.revoke(token.access_token);
			gapi.client.setToken("");
			 }

			 authorizeButton.textContent = "ğŸ” ÄÄƒng nháº­p Google";
			 authorizeButton.disabled = false;
			 signoutButton.disabled = true;
			 uploadButton.disabled = true;
			 listButton.disabled = true;
			filesToUpload = []; 
			progressDisplay.style.display = 'none';
			filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ xem danh sÃ¡ch file.</td></tr>';
			listStatus.textContent = "ChÆ°a táº£i danh sÃ¡ch file.";
			
			// Reset Ä‘iá»u hÆ°á»›ng
			currentFolderId = 'root';
			folderHistory = [{ id: 'root', name: 'Drive cá»§a tÃ´i' }];
			renderBreadcrumb();

			 authStatus.textContent = "ÄÃ£ Ä‘Äƒng xuáº¥t. Cáº§n Ä‘Äƒng nháº­p láº¡i Ä‘á»ƒ sá»­ dá»¥ng.";
			 authStatus.classList.remove("success");
		};
        
        // =========================================================
        // === HÃ€M Xá»¬ LÃ UPLOAD ===
        // =========================================================
        
		// HÃ m kiá»ƒm tra vÃ  táº¡o Folder trÃªn Drive náº¿u cáº§n
		async function createFolderIfNeeded(pathSegments, parentId = 'root') {
			let currentParentId = parentId;
			let currentPath = '';

			for (const segment of pathSegments) {
				currentPath = (currentPath ? currentPath + '/' : '') + segment;

				if (folderIdCache[currentPath]) {
					currentParentId = folderIdCache[currentPath];
					continue;
				}

				const query = `name = '${segment.replace(/'/g, "\\'")}' and mimeType = 'application/vnd.google-apps.folder' and '${currentParentId}' in parents and trashed = false`;
				const searchRes = await gapi.client.drive.files.list({
					q: query,
					fields: 'files(id)',
					pageSize: 1,
				});

				if (searchRes.result.files.length > 0) {
					currentParentId = searchRes.result.files[0].id;
				} else {
					const folderMetadata = {
						'name': segment,
						'mimeType': 'application/vnd.google-apps.folder',
						'parents': [currentParentId],
					};

					const createRes = await gapi.client.drive.files.create({
						resource: folderMetadata,
						fields: 'id',
					});
					currentParentId = createRes.result.id;
				}

				folderIdCache[currentPath] = currentParentId;
			}
			return currentParentId;
		}

		// HÃ m upload file
		uploadButton.onclick = async () => {
			uploadStatus.classList.remove("error", "success");
			const token = gapi.client.getToken();
			if (!token) {
				uploadStatus.textContent = "Báº¡n cáº§n Ä‘Äƒng nháº­p Google trÆ°á»›c.";
				uploadStatus.classList.add("error");
				return;
			}

			const files = filesToUpload; 
			if (files.length === 0) {
				uploadStatus.textContent = "Vui lÃ²ng chá»n file hoáº·c thÆ° má»¥c Ä‘á»ƒ upload.";
				uploadStatus.classList.add("error");
				return;
			}

			uploadButton.disabled = true;
			listButton.disabled = true;
			progressDisplay.style.display = 'block';
			
			let successCount = 0;
			let errorCount = 0;
			
			uploadStatus.textContent = `Äang chuáº©n bá»‹ upload ${files.length} má»¥c...`;

			try {
				Object.keys(folderIdCache).forEach(k => delete folderIdCache[k]); 

				for (let i = 0; i < files.length; i++) {
					const file = files[i];
					const totalSize = file.size;
					const formattedTotalSize = formatBytes(totalSize);

					progressText.textContent = `Äang upload ${i + 1}/${files.length}: ${file.name}... (0 B / ${formattedTotalSize})`;
					progressBarInner.style.width = '0%';


					// 1. Xá»­ lÃ½ Ä‘Æ°á»ng dáº«n thÆ° má»¥c cha
					let parentFolderId = 'root'; 

					if (file.webkitRelativePath) {
						const parts = file.webkitRelativePath.split('/');
						const pathSegments = parts.slice(0, -1); 

						if (pathSegments.length > 0) {
							parentFolderId = await createFolderIfNeeded(pathSegments, 'root');
						}
					}

					// 2. Upload file vá»›i tiáº¿n trÃ¬nh hiá»ƒn thá»‹
					const metadata = {
						name: file.name,
						mimeType: file.type || "application/octet-stream",
						parents: [parentFolderId], 
					};
					
					const form = new FormData();
					form.append(
						"metadata",
						new Blob([JSON.stringify(metadata)], { type: "application/json" })
					);
					form.append("file", file);

					const xhr = new XMLHttpRequest();
					
					// HÃ m cáº­p nháº­t tiáº¿n trÃ¬nh
					xhr.upload.onprogress = (event) => {
						if (event.lengthComputable) {
							const uploaded = event.loaded;
							const percent = Math.round((uploaded / totalSize) * 100);
							progressText.textContent = `Äang upload ${i + 1}/${files.length}: ${file.name}... (${formatBytes(uploaded)} / ${formattedTotalSize})`;
							progressBarInner.style.width = `${percent}%`;
						}
					};

					xhr.open(
						"POST",
						"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,iconLink,size,mimeType"
					);

					xhr.setRequestHeader("Authorization", "Bearer " + token.access_token);

					await new Promise((resolve, reject) => {
						xhr.onload = () => {
							if (xhr.status >= 200 && xhr.status < 300) {
								successCount++;
								resolve();
							} else {
								errorCount++;
								console.error("Lá»—i upload file:", file.name, xhr.responseText);
								reject(new Error(`Lá»—i upload: ${xhr.status}`));
							}
						};
						xhr.onerror = () => {
							errorCount++;
							console.error("Lá»—i máº¡ng khi upload:", file.name);
							reject(new Error("Lá»—i máº¡ng/káº¿t ná»‘i"));
						};
						xhr.send(form);
					});
				}
				
				// Cáº­p nháº­t tráº¡ng thÃ¡i cuá»‘i cÃ¹ng
				const totalUploaded = successCount + errorCount;
				progressDisplay.style.display = 'none';
				if (errorCount === 0) {
					uploadStatus.textContent = `âœ… Upload thÃ nh cÃ´ng ${successCount}/${totalUploaded} má»¥c!`;
					uploadStatus.classList.add("success");
					uploadStatus.classList.remove("error");
				} else {
					uploadStatus.textContent = `âš ï¸ HoÃ n táº¥t: Upload thÃ nh cÃ´ng ${successCount}/${totalUploaded} má»¥c, tháº¥t báº¡i ${errorCount} má»¥c. Kiá»ƒm tra console Ä‘á»ƒ biáº¿t chi tiáº¿t.`;
					uploadStatus.classList.add("error");
					uploadStatus.classList.remove("success");
				}

				// Reset filesToUpload vÃ  cáº­p nháº­t tráº¡ng thÃ¡i
				filesToUpload = []; 
				updateUploadInputStatus(); 

				// Náº¿u upload vÃ o thÆ° má»¥c hiá»‡n táº¡i, táº£i láº¡i danh sÃ¡ch file
				if (currentFolderId === 'root') {
					await listFiles();
				}
				
			} catch (error) {
				console.error(error);
				progressDisplay.style.display = 'none';
				uploadStatus.textContent = "Lá»—i upload tá»•ng quÃ¡t: " + error.message;
				uploadStatus.classList.add("error");
				uploadStatus.classList.remove("success");
			} finally {
				uploadButton.disabled = false;
				listButton.disabled = false;
			}
		};
        
        // =========================================================
        // === HÃ€M LIá»†T KÃŠ FILE VÃ€ ÄIá»€U HÆ¯á»šNG ===
        // =========================================================
		
		// HÃ m Ä‘iá»u hÆ°á»›ng lá»‹ch sá»­
		function navigateHistory(index) {
			if (index < 0 || index >= folderHistory.length - 1) return;
			
			const targetFolder = folderHistory[index];
			folderHistory = folderHistory.slice(0, index + 1);
			
			listFiles(targetFolder.id);
		}
		
		// HÃ m render breadcrumb
		function renderBreadcrumb() {
			let path = 'ÄÆ°á»ng dáº«n hiá»‡n táº¡i: ';
			
			// Táº¡o chuá»—i Ä‘Æ°á»ng dáº«n vá»›i cÃ¡c thÆ° má»¥c cha cÃ³ thá»ƒ click Ä‘Æ°á»£c
			path += folderHistory.map((item, index) => {
				if (index < folderHistory.length - 1) {
					// Sá»­ dá»¥ng function navigateHistory() Ä‘á»ƒ chuyá»ƒn thÆ° má»¥c
					return `<a href="javascript:void(0)" class="link" onclick="navigateHistory(${index})">${item.name}</a>`;
				}
				return `<strong>${item.name}</strong>`;
			}).join(' / ');
			
			breadcrumbPath.innerHTML = path;
			
			// Cáº­p nháº­t tráº¡ng thÃ¡i nÃºt Quay láº¡i
			if (folderHistory.length > 1) {
				goBackButton.disabled = false;
				goBackButton.style.display = 'inline-flex';
			} else {
				goBackButton.disabled = true;
				goBackButton.style.display = 'none';
			}
		}


		// List files khi báº¥m nÃºt
		listButton.onclick = () => {
			// Thiáº¿t láº­p láº¡i thÆ° má»¥c gá»‘c vÃ  táº£i láº¡i
			folderHistory = [{ id: 'root', name: 'Drive cá»§a tÃ´i' }];
			listFiles('root');
		};

		// HÃ m liá»‡t kÃª file (nháº­n folderId lÃ m tham sá»‘)
		async function listFiles(folderId = 'root') {
			 listStatus.classList.remove("error", "success");
			 const token = gapi.client.getToken();
			 if (!token) {
			listStatus.textContent = "Báº¡n cáº§n Ä‘Äƒng nháº­p Google trÆ°á»›c.";
			listStatus.classList.add("error");
			return;
			 }
			
			 // Cáº­p nháº­t ID thÆ° má»¥c hiá»‡n táº¡i
			currentFolderId = folderId;
			renderBreadcrumb(); // Cáº­p nháº­t Ä‘Æ°á»ng dáº«n

			 listButton.disabled = true;
			 listStatus.textContent = "Äang táº£i danh sÃ¡ch file...";
			 filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">Äang táº£i...</td></tr>';

			 try {
			const response = await gapi.client.drive.files.list({
				 pageSize: 50, // TÄƒng giá»›i háº¡n hiá»ƒn thá»‹
				 fields: "files(id,name,mimeType,modifiedTime,iconLink,webViewLink,size)",
				 // Æ¯u tiÃªn hiá»ƒn thá»‹ Folder trÆ°á»›c, sau Ä‘Ã³ sáº¯p xáº¿p theo tÃªn
				 orderBy: "folder,name",
				 // Truy váº¥n: chá»‰ láº¥y cÃ¡c má»¥c cÃ³ thÆ° má»¥c cha lÃ  currentFolderId VÃ€ KHÃ”NG Bá»Š XOÃ
				 q: `'${currentFolderId}' in parents and trashed = false`, 
			});

			const files = response.result.files || [];
			filesTbody.innerHTML = "";

			if (files.length === 0) {
				 listStatus.textContent = "KhÃ´ng tÃ¬m tháº¥y file/thÆ° má»¥c nÃ o trong thÆ° má»¥c nÃ y.";
				 listStatus.classList.add("success");
				 filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">ThÆ° má»¥c nÃ y trá»‘ng.</td></tr>';
				 return;
			}

			for (const file of files) {
				 const tr = document.createElement("tr");

				 const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
				 
				 // Gáº¯n sá»± kiá»‡n click vÃ o hÃ ng náº¿u Ä‘Ã³ lÃ  thÆ° má»¥c
				 if (isFolder) {
				tr.classList.add('folder-row');
				tr.onclick = () => {
					// ThÃªm thÆ° má»¥c vÃ o lá»‹ch sá»­ vÃ  táº£i danh sÃ¡ch file má»›i
					folderHistory.push({ id: file.id, name: file.name });
					listFiles(file.id); 
				};
				 }

				 const nameTd = document.createElement("td");
				 nameTd.textContent = file.name || "(KhÃ´ng tÃªn)";
			  // ThÃªm data-label cho responsive
			  nameTd.setAttribute('data-label', 'TÃªn file');

				 const typeTd = document.createElement("td");
				 const tag = document.createElement("span");
				 tag.className = "tag";
				 tag.textContent = isFolder ? "ğŸ“ Folder" : (file.mimeType || "Unknown");	
				 typeTd.appendChild(tag);
			  typeTd.setAttribute('data-label', 'Loáº¡i');

				 const modifiedTd = document.createElement("td");
				 modifiedTd.textContent = file.modifiedTime
				? new Date(file.modifiedTime).toLocaleString()
				: "";
			  modifiedTd.setAttribute('data-label', 'Cáº­p nháº­t');

				 const sizeTd = document.createElement("td");
				 sizeTd.textContent = isFolder	
				? "-" 
				: (file.size ? formatBytes(parseInt(file.size, 10)) : "-");
			  sizeTd.setAttribute('data-label', 'KÃ­ch thÆ°á»›c');

				 const linkTd = document.createElement("td");
			  linkTd.setAttribute('data-label', 'Xem');
				 if (file.webViewLink) {
				const a = document.createElement("a");
				a.href = file.webViewLink;
				a.target = "_blank";
				a.rel = "noopener noreferrer";
				a.className = "link";
				a.textContent = isFolder ? "Má»Ÿ Folder" : "Xem File";
				// Náº¿u lÃ  folder, khÃ´ng cho phÃ©p click vÃ o link á»Ÿ cá»™t nÃ y (vÃ¬ Ä‘Ã£ click vÃ o row)
				if (isFolder) {
					a.style.opacity = '0.7';
					a.onclick = (e) => { e.stopPropagation(); }; // NgÄƒn cháº·n sá»± kiá»‡n click lan truyá»n lÃªn row
				}
				linkTd.appendChild(a);
				 } else {
				linkTd.textContent = "-";
				 }

				 tr.appendChild(nameTd);
				 tr.appendChild(typeTd);
				 tr.appendChild(modifiedTd);
				 tr.appendChild(sizeTd);
				 tr.appendChild(linkTd);

				 filesTbody.appendChild(tr);
			}

			listStatus.textContent = `ÄÃ£ táº£i ${files.length} má»¥c.`;
			listStatus.classList.add("success");
			 } catch (error) {
			console.error(error);
			listStatus.textContent = "Lá»—i táº£i danh sÃ¡ch file: " + error.message;
			listStatus.classList.add("error");
			 } finally {
			listButton.disabled = false;
			 }
		}

		// Helper format size
		function formatBytes(bytes) {
			 if (bytes === 0) return "0 B";
			 const k = 1024;
			 const sizes = ["B", "KB", "MB", "GB", "TB"];
			 const i = Math.floor(Math.log(bytes) / Math.log(k));
			 return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
		}
	</script>
	 	 <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
	 <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
